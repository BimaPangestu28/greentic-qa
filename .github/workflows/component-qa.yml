name: Component QA CI

on:
  push:
    branches: ["main", "master"]
  pull_request:

permissions:
  contents: read
  packages: write

jobs:
  rust:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-wasip2

      - name: Ensure wasm target on pinned toolchain
        run: rustup target add wasm32-wasip2 --toolchain 1.90.0-x86_64-unknown-linux-gnu

      - name: Cargo fmt
        run: cargo fmt --all -- --check

      - name: Cargo clippy
        run: cargo clippy --workspace --all-targets -- -D warnings

      - name: Cargo test
        run: cargo test --workspace --all-targets

      - name: Cargo check (wasm32-wasip2)
        run: cargo check --target wasm32-wasip2

      - name: Build WASM (component-qa)
        run: cargo build -p component-qa --target wasm32-wasip2 --release

      - name: Prepare publish artifacts
        if: github.ref == 'refs/heads/master'
        run: |
          cp target/wasm32-wasip2/release/component_qa.wasm component_qa.wasm
          cp component.manifest.json component.publish.manifest.json
          jq '.artifacts.component_wasm = "component_qa.wasm"' component.publish.manifest.json > component.publish.tmp && mv component.publish.tmp component.publish.manifest.json
          python -m pip install --user blake3
          python - <<'PY'
          import json
          from pathlib import Path
          import blake3

          manifest = Path("component.publish.manifest.json")
          wasm_path = Path("component_qa.wasm")

          data = json.loads(manifest.read_text())
          digest = blake3.blake3(wasm_path.read_bytes()).hexdigest()
          data["hashes"]["component_wasm"] = f"blake3:{digest}"
          manifest.write_text(json.dumps(data, indent=2))
          PY
          ls -l component_qa.wasm component.publish.manifest.json

      - name: Install ORAS
        if: github.ref == 'refs/heads/master'
        uses: oras-project/setup-oras@v1

      - name: Login to GHCR
        if: github.ref == 'refs/heads/master'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: echo "${GITHUB_TOKEN}" | oras login ghcr.io -u "${{ github.actor }}" --password-stdin

      - name: Push OCI artifact to GHCR
        if: github.ref == 'refs/heads/master'
        env:
          IMAGE: ghcr.io/greentic-ai/components/component-qa
        run: |
          VERSION=$(cargo metadata --no-deps --format-version=1 | jq -r '.packages[] | select(.name=="component-qa") | .version')
          oras push "${IMAGE}:latest" \
            --annotation org.opencontainers.image.source="${{ github.server_url }}/${{ github.repository }}" \
            component.publish.manifest.json:application/vnd.greentic.component.manifest+json \
            component_qa.wasm:application/wasm
          oras push "${IMAGE}:${VERSION}" \
            --annotation org.opencontainers.image.source="${{ github.server_url }}/${{ github.repository }}" \
            component.publish.manifest.json:application/vnd.greentic.component.manifest+json \
            component_qa.wasm:application/wasm
