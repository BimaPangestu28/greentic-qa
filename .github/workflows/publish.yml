name: Publish

on:
  workflow_run:
    workflows:
      - CI
    types:
      - completed

permissions:
  contents: write
  packages: write

defaults:
  run:
    shell: bash

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  publish_crates:
    if: ${{ github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'master' }}
    runs-on: ubuntu-latest
    env:
      CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.90.0

      - name: Verify publish candidates
        run: |
          for crate in crates/qa-spec crates/component-qa crates/qa-cli; do
            (
              cd "$crate"
              cargo publish --dry-run
            )
          done

      - name: Publish crates
        run: |
          for crate in crates/qa-spec crates/component-qa crates/qa-cli; do
            (
              cd "$crate"
              cargo publish --token "$CARGO_REGISTRY_TOKEN"
            )
          done

  binstall_matrix:
    if: ${{ github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'master' }}
    runs-on: ${{ matrix.os }}
    env:
      CARGO_BINSTALL_TARGET: ${{ matrix.target }}
    name: Binstall verification ${{ matrix.os }}-${{ matrix.arch }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            arch: x64
            target: x86_64-unknown-linux-gnu
          - os: windows-latest
            arch: x64
            target: x86_64-pc-windows-msvc
          - os: macos-15
            arch: x64
            target: x86_64-apple-darwin
          - os: macos-15
            arch: arm64
            target: aarch64-apple-darwin
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.90.0

      - name: Install cargo-binstall
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-binstall
          version: latest

      - name: Run binstall verification
        run: |
          chmod +x ci/scripts/binstall_verify.sh
          ./ci/scripts/binstall_verify.sh

  smoke:
    if: ${{ github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'master' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.90.0

      - name: Run smoke tests
        run: |
          chmod +x ci/scripts/smoke.sh
          ./ci/scripts/smoke.sh
