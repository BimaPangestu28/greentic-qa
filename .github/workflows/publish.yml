name: Publish

on:
  workflow_run:
    workflows:
      - CI
    types:
      - completed

jobs:
  publish_crates:
    if: ${{ github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'master' }}
    runs-on: ubuntu-latest
    env:
      CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: 1.90.0
          override: true

      - name: Publish workspace crates (dry run)
        run: cargo publish --workspace --dry-run

  binstall_matrix:
    if: ${{ github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'master' }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
          - os: windows-latest
          - os: macos-15
            arch: x64
          - os: macos-15
            arch: arm64
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run binstall verification
        shell: bash
        run: |
          chmod +x ci/scripts/binstall_verify.sh
          ./ci/scripts/binstall_verify.sh

  smoke:
    if: ${{ github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'master' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run smoke tests
        shell: bash
        run: |
          chmod +x ci/scripts/smoke.sh
          ./ci/scripts/smoke.sh
